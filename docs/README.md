# æ— æ„Ÿå¿«ç…§æŠ€æœ¯æ–‡æ¡£

## ğŸ“š æ–‡æ¡£æ¦‚è§ˆ

æœ¬ç›®å½•åŒ…å«äº†æ— æ„Ÿå¿«ç…§ï¼ˆSeamless Snapshotï¼‰æŠ€æœ¯çš„å®Œæ•´æ–‡æ¡£ï¼Œæ¶µç›–äº†ä»æŠ€æœ¯æ¦‚è¿°åˆ°APIå‚è€ƒçš„æ‰€æœ‰å†…å®¹ã€‚

## ğŸ¯ ä»€ä¹ˆæ˜¯æ— æ„Ÿå¿«ç…§ï¼Ÿ

æ— æ„Ÿå¿«ç…§æ˜¯ä¸€ç§åˆ›æ–°çš„å®¹å™¨å¿«ç…§æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨æçŸ­çš„æ—¶é—´å†…ï¼ˆ~20Âµsï¼‰å¯¹è¿è¡Œä¸­çš„å®¹å™¨è¿›è¡Œå¿«ç…§ï¼ŒåŒæ—¶ä¿è¯ï¼š

- âœ… **æçŸ­æš‚åœæ—¶é—´**: ~20Âµsï¼ˆ0.02msï¼‰ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… **æ•°æ®å®Œæ•´æ€§**: 100%ä¿ç•™ç”¨æˆ·æ•°æ®å’Œæ–‡ä»¶ä¿®æ”¹
- âœ… **æœåŠ¡è¿ç»­æ€§**: å®¹å™¨æœåŠ¡ä¸ä¸­æ–­
- âœ… **å¼‚æ­¥å¤„ç†**: åå°å¤„ç†ä¸å½±å“ç”¨æˆ·ä½“éªŒ

## ğŸ“– æ–‡æ¡£ç»“æ„

### 1. [æŠ€æœ¯æ¦‚è¿°](./seamless-snapshot.md)
- æ ¸å¿ƒç‰¹æ€§å’ŒæŠ€æœ¯ä¼˜åŠ¿
- ä½¿ç”¨æ–¹æ³•å’Œç¤ºä¾‹
- æ€§èƒ½æŒ‡æ ‡å’Œæ•…éšœæ’é™¤
- ä¸ä¼ ç»Ÿæ–¹æ¡ˆçš„å¯¹æ¯”

### 2. [æŠ€æœ¯è®¾è®¡](./technical-design.md)
- è¯¦ç»†çš„æ¶æ„è®¾è®¡
- æ ¸å¿ƒç®—æ³•å®ç°
- é”™è¯¯å¤„ç†ä¸æ¢å¤æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 3. [APIå‚è€ƒ](./api-reference.md)
- å‘½ä»¤è¡Œæ¥å£è¯¦ç»†è¯´æ˜
- Go APIä½¿ç”¨æŒ‡å—
- REST APIè®¾è®¡ï¼ˆæœªæ¥æ‰©å±•ï¼‰
- é”™è¯¯ä»£ç å’Œç›‘æ§æŒ‡æ ‡

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone <repository>

# ç¼–è¯‘
cd contrib/nydusify
go build -o cmd/nydusify cmd/nydusify.go
```

### åŸºæœ¬ä½¿ç”¨

```bash
# å¯¹è¿è¡Œä¸­çš„å®¹å™¨æ‰§è¡Œæ— æ„Ÿå¿«ç…§
./cmd/nydusify seamless-commit \
    --container mycontainer \
    --target registry.example.com/myimage:snapshot

# ç­‰å¾…åå°å¤„ç†å®Œæˆ
./cmd/nydusify seamless-commit \
    --container mycontainer \
    --target registry.example.com/myimage:snapshot \
    --wait
```

### éªŒè¯ç»“æœ

```bash
# æ‹‰å–å¿«ç…§é•œåƒ
nerdctl pull registry.example.com/myimage:snapshot

# è¿è¡Œå¿«ç…§é•œåƒ
nerdctl run -it registry.example.com/myimage:snapshot bash

# éªŒè¯ç”¨æˆ·æ•°æ®æ˜¯å¦ä¿ç•™
ls -la /path/to/user/files
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å‘½ä»¤è¡Œ    â”‚â”€â”€â”€â–¶â”‚  æ— æ„Ÿå¿«ç…§æ ¸å¿ƒ    â”‚â”€â”€â”€â–¶â”‚   åå°å¤„ç†å™¨    â”‚
â”‚   nydusify CLI  â”‚    â”‚ SeamlessSnapshot â”‚    â”‚ BackgroundProc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¹å™¨è¿è¡Œæ—¶    â”‚    â”‚   æ–‡ä»¶ç³»ç»Ÿå±‚     â”‚    â”‚   é•œåƒä»“åº“      â”‚
â”‚   Containerd    â”‚    â”‚ Overlay FS       â”‚    â”‚   ECR Registry  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å®¹å™¨æš‚åœæ—¶é—´ | ~20Âµs | ç”¨æˆ·æ— æ„ŸçŸ¥çš„å…³é”®æŒ‡æ ‡ |
| å¿«ç…§å“åº”æ—¶é—´ | ~25ms | ç”¨æˆ·å‘½ä»¤å®Œæˆæ—¶é—´ |
| åå°å¤„ç†æ—¶é—´ | ~1åˆ†é’Ÿ | é•œåƒæ„å»ºå’Œæ¨é€æ—¶é—´ |
| æ•°æ®ä¿ç•™ç‡ | 100% | ç”¨æˆ·æ•°æ®å®Œæ•´æ€§ä¿è¯ |

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### 1. æçŸ­æš‚åœæ—¶é—´
- **ç›®æ ‡**: å®¹å™¨æš‚åœæ—¶é—´ < 10ms
- **å®é™…è¾¾æˆ**: ~20Âµsï¼ˆ0.02msï¼‰
- **æŠ€æœ¯æ‰‹æ®µ**: ä¼˜åŒ–çš„åŸå­æ“ä½œå’Œæ–‡ä»¶ç³»ç»Ÿå¤„ç†

### 2. æ•°æ®å®Œæ•´æ€§ä¿è¯
- **ç”¨æˆ·æ–‡ä»¶**: æ‰€æœ‰ç”¨æˆ·åˆ›å»ºå’Œä¿®æ”¹çš„æ–‡ä»¶å®Œæ•´ä¿ç•™
- **åº”ç”¨çŠ¶æ€**: åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶çŠ¶æ€æ­£ç¡®ä¿å­˜
- **æ–‡ä»¶ç³»ç»Ÿ**: overlayæ–‡ä»¶ç³»ç»ŸçŠ¶æ€ä¸€è‡´æ€§ä¿è¯

### 3. å¼‚æ­¥åå°å¤„ç†
- **ç«‹å³å“åº”**: å¿«ç…§æ“ä½œç«‹å³è¿”å›ç»™ç”¨æˆ·
- **åå°æ„å»º**: é•œåƒæ„å»ºå’Œæ¨é€åœ¨åå°å¼‚æ­¥è¿›è¡Œ
- **çŠ¶æ€ç›‘æ§**: æä¾›å®Œæ•´çš„å¤„ç†çŠ¶æ€å’Œè¿›åº¦ä¿¡æ¯

### 4. é”™è¯¯å¤„ç†ä¸æ¢å¤
- **åŸå­æ€§ä¿è¯**: æ“ä½œè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å›æ»š
- **è‡ªåŠ¨æ¢å¤**: å¼‚å¸¸æƒ…å†µä¸‹è‡ªåŠ¨æ¢å¤å®¹å™¨çŠ¶æ€
- **è¯¦ç»†æ—¥å¿—**: æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ—¥å¿—

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### ä»£ç ç»“æ„

```
contrib/nydusify/
â”œâ”€â”€ pkg/committer/
â”‚   â”œâ”€â”€ seamless_snapshot.go    # æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ committer.go           # åŸºç¡€committer
â”‚   â””â”€â”€ manager.go             # å®¹å™¨ç®¡ç†
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ nydusify.go           # CLIå…¥å£
â””â”€â”€ docs/
    â”œâ”€â”€ README.md             # æ–‡æ¡£å…¥å£
    â”œâ”€â”€ seamless-snapshot.md  # æŠ€æœ¯æ¦‚è¿°
    â”œâ”€â”€ technical-design.md   # æŠ€æœ¯è®¾è®¡
    â””â”€â”€ api-reference.md      # APIå‚è€ƒ
```

### æ ¸å¿ƒæ¥å£

```go
// ä¸»è¦æ¥å£
type SeamlessSnapshot interface {
    Commit(ctx context.Context, containerID, targetRef string) (*SnapshotResult, error)
    CommitWithWait(ctx context.Context, containerID, targetRef string, timeout time.Duration) (*SnapshotResult, error)
    GetStatus(snapshotID string) (*SnapshotStatus, error)
}

// ç»“æœç»“æ„
type SnapshotResult struct {
    SnapshotID   string        `json:"snapshot_id"`
    PauseTime    time.Duration `json:"pause_time"`
    TotalTime    time.Duration `json:"total_time"`
    OldUpperDir  string        `json:"old_upper_dir"`
    NewUpperDir  string        `json:"new_upper_dir"`
}
```

### æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
go test ./pkg/committer/...

# è¿è¡Œé›†æˆæµ‹è¯•
go test -tags=integration ./...

# æ€§èƒ½æµ‹è¯•
go test -bench=. ./pkg/committer/
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å®¹å™¨æš‚åœæ—¶é—´è¿‡é•¿**
   - æ£€æŸ¥æ–‡ä»¶ç³»ç»ŸçŠ¶æ€
   - æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½

2. **åå°å¤„ç†å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯registryè®¤è¯

3. **ç”¨æˆ·æ•°æ®ä¸¢å¤±**
   - ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
   - æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™

### è°ƒè¯•æ–¹æ³•

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export LOG_LEVEL=debug

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
nerdctl inspect <container-id>

# æŸ¥çœ‹å¿«ç…§ç›®å½•
ls -la /data/containerd/io.containerd.snapshotter.v1.nydus/snapshots/
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. **å®‰è£…ä¾èµ–**
   ```bash
   # Go 1.19+
   # containerd + nerdctl
   # nydus-snapshotter
   ```

2. **å…‹éš†ä»£ç **
   ```bash
   git clone <repository>
   cd contrib/nydusify
   ```

3. **ç¼–è¯‘æµ‹è¯•**
   ```bash
   go build -o cmd/nydusify cmd/nydusify.go
   ./cmd/nydusify --help
   ```

### æäº¤è§„èŒƒ

- **åŠŸèƒ½å¼€å‘**: `feat: add new feature`
- **é—®é¢˜ä¿®å¤**: `fix: resolve issue with xxx`
- **æ–‡æ¡£æ›´æ–°**: `docs: update API documentation`
- **æ€§èƒ½ä¼˜åŒ–**: `perf: optimize atomic switch performance`

### ä»£ç å®¡æŸ¥

- ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æ·»åŠ é€‚å½“çš„å•å…ƒæµ‹è¯•
- æ›´æ–°ç›¸å…³æ–‡æ¡£
- éµå¾ªGoä»£ç è§„èŒƒ

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache 2.0 è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](../LICENSE) æ–‡ä»¶ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- [Nydusé¡¹ç›®ä¸»é¡µ](https://github.com/dragonflyoss/nydus)
- [Containerdæ–‡æ¡£](https://containerd.io/docs/)
- [Overlayæ–‡ä»¶ç³»ç»Ÿ](https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt)

---

**æ— æ„Ÿå¿«ç…§æŠ€æœ¯** - è®©å®¹å™¨å¿«ç…§çœŸæ­£åšåˆ°"æ— æ„ŸçŸ¥"ï¼ğŸš€

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚
